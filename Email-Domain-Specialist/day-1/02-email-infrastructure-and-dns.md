# Email Infrastructure & DNS  
## Email-инфраструктура и DNS-аутентификация (iGaming)

## Цель модуля

Научиться **самостоятельно настраивать, проверять и аудитить email-инфраструктуру и DNS-аутентификацию**
для iGaming-проектов без слепой зависимости от ESP или DevOps.

Модуль отвечает на вопрос:  
**почему письма уходят в spam даже при “настроенных” SPF / DKIM / DMARC**.

---

## Роль инфраструктуры в deliverability

Deliverability — это не контент и не кнопка “Send”.  
Это результат корректной работы цепочки:

```
Application → ESP / MTA → SMTP → DNS → ISP → Inbox / Spam
```

Ошибка на любом уровне приводит к:
- деградации репутации,
- снижению inbox placement,
- росту bounce и spam complaints.

---

## Базовые компоненты email-инфраструктуры

### SMTP / MTA

Минимальный набор, который нужно понимать:
- SMTP — протокол передачи почты
- MTA — сервер отправки (ESP или собственный)
- HELO / EHLO — идентификация сервера
- TLS — защищённое соединение

Deliverability-специалист **не обязан администрировать MTA**,  
но обязан уметь читать симптомы проблем.

---

## DNS как фундамент доверия

ISP доверяют **не письму**, а:
- домену,
- инфраструктуре,
- подтверждённым DNS-сигналам.

Три обязательных механизма:
- SPF
- DKIM
- DMARC

Отсутствие или некорректная настройка любого из них = снижение доверия.

---

## SPF (Sender Policy Framework)

### Назначение
SPF определяет, **кто имеет право отправлять письма от имени домена**.

### Пример корректного SPF

```
v=spf1 include:esp1.com include:esp2.com -all
```

### Критические правила
- всегда **один SPF-запись**
- не более 10 DNS lookups
- `-all` или `~all` — осознанно
- include только реально используемых источников

### Типовые ошибки SPF
- несколько SPF-записей
- забытые include старых ESP
- превышение лимита lookups
- отсутствие alignment с From-доменом

---

## DKIM (DomainKeys Identified Mail)

### Назначение
DKIM подтверждает, что письмо:
- не было изменено,
- действительно отправлено от домена.

### Что важно на практике
- длина ключа: **2048 bit**
- корректный selector
- alignment с From-доменом

### Пример DKIM-записи

```
selector1._domainkey.domain.com IN TXT (
  "v=DKIM1; k=rsa; p=MIIBIjANBgkq..."
)
```

### Типовые ошибки DKIM
- короткий ключ (1024)
- selector не совпадает с ESP
- подпись есть, но не aligned

---

## DMARC (Domain-based Message Authentication)

### Назначение
DMARC определяет, **что делать, если SPF/DKIM не прошли**.

### Рекомендуемая стратегия

1. `p=none` — мониторинг
2. `p=quarantine` — мягкое ограничение
3. `p=reject` — строгая политика

### Пример DMARC

```
v=DMARC1; p=none; rua=mailto:dmarc@domain.com; ruf=mailto:dmarc@domain.com; fo=1
```

### Частые ошибки DMARC
- сразу `p=reject`
- отсутствие отчётов
- игнорирование alignment

---

## Alignment — ключевой момент

Alignment означает совпадение:
- From-домена
- DKIM-домена
- SPF-домена

Без alignment:
- формально auth есть,
- доверия у ISP нет.

---

## HELO / PTR / rDNS

Для dedicated IP:
- PTR должен указывать на домен
- HELO совпадать с PTR
- IP не должен быть “generic”

Ошибка здесь = фильтрация на уровне SMTP.

---

## TLS и безопасность

- TLS должен быть включён
- отсутствие TLS снижает доверие
- современные ISP учитывают security posture

---

## Практический аудит DNS (чек-лист)

Перед отправкой писем проверь:

- [ ] один SPF
- [ ] DKIM 2048 bit
- [ ] DMARC с отчётами
- [ ] alignment пройден
- [ ] HELO/PTR корректны
- [ ] TLS активен

---

## Практическое задание

### Сценарий
Домен добавлен в ESP, письма отправляются, но:
- Gmail — spam
- Postmaster — Low reputation

### Задача
1. Проверить SPF / DKIM / DMARC
2. Найти потенциальные ошибки
3. Предложить исправления
4. Объяснить, почему письма уходили в spam

Формат ответа — таблица:
| Компонент | Проблема | Решение |

---

## Типовые анти-паттерны

- «ESP всё настроил за нас»
- «SPF есть — значит всё ок»
- «DKIM подписан, но не aligned»
- «DMARC не нужен»

---

## Критерии корректной настройки

Настройка считается корректной, если:
- все три механизма работают совместно
- alignment соблюдён
- DNS чист и минимален
- отчёты анализируются

---

## Что дальше

Следующий модуль:
**03-domain-warming.md**

В нём:
- логика прогрева домена,
- volume curves,
- stop-loss правила,
- контроль сигналов ISP.

---

*Deliverability начинается с DNS.  
Ошибки в DNS стоят дороже любого контента.*


