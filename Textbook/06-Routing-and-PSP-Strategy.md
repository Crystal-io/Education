# 06. Routing and PSP Strategy: оптимизация платежных потоков

## Цель главы

Эта глава посвящена routing-стратегии и управлению PSP-провайдерами
как ключевому инструменту PSP Account Manager (Operations).

После прочтения ты должен:
- понимать, зачем нужен routing и почему «один PSP» — плохая идея;
- знать основные модели routing и fallback;
- уметь балансировать approval, cost и risk;
- понимать влияние GEO, валют и локальных методов;
- говорить о routing как о бизнес-инструменте, а не технической настройке.

---

## 1. Что такое routing в платежах

Routing — это логика выбора платежного провайдера (PSP)
для конкретной платежной попытки.

Routing может учитывать:
- метод оплаты;
- GEO клиента;
- валюту;
- тип транзакции (deposit / payout);
- risk score;
- исторические метрики провайдеров.

Ключевая идея:
> routing — это способ управлять качеством платежей в реальном времени.

---

## 2. Почему single-PSP — стратегическая ошибка

Использование одного PSP приводит к:
- полной зависимости от одного провайдера;
- невозможности fallback при инцидентах;
- слабой переговорной позиции;
- риску массовых outage.

Зрелая платежная система всегда:
- имеет минимум 2 PSP на ключевые методы;
- поддерживает fallback;
- регулярно сравнивает performance провайдеров.

---

## 3. Основные модели routing

### 3.1. Static routing

Простейшая модель:
- один метод → один PSP.

Плюсы:
- простота;
- предсказуемость.

Минусы:
- отсутствие гибкости;
- высокий риск при инцидентах.

---

### 3.2. Priority routing

PSP выстраиваются по приоритету:
1. Primary
2. Secondary
3. Fallback

Используется, когда:
- один PSP стабильно лучше;
- fallback нужен только при деградации.

---

### 3.3. Weighted routing

Трафик распределяется по весам:
- PSP A — 70%
- PSP B — 30%

Позволяет:
- тестировать провайдеров;
- снижать риски;
- оптимизировать cost.

---

### 3.4. Rule-based routing

Routing основан на правилах:
- GEO;
- BIN / issuer;
- amount;
- risk flags.

Самая гибкая модель, но:
- сложная в поддержке;
- требует хороших метрик.

---

## 4. Fallback и retry стратегия

Fallback — переключение на альтернативный PSP
при неуспешной попытке.

Важно:
- fallback ≠ unlimited retry;
- каждый retry увеличивает risk и cost.

Хорошая стратегия:
- ограниченное число retries;
- idempotency;
- учёт причины отказа.

---

## 5. GEO, валюты и локальные методы

### 5.1. Tier-1 vs Tier-2 GEO

Tier-1:
- высокая регуляция;
- стабильные банки;
- низкий fraud.

Tier-2:
- выше approval volatility;
- больше локальных методов;
- выше risk.

Routing должен учитывать специфику GEO.

---

### 5.2. Локальные методы оплаты

Локальные методы:
- повышают conversion;
- требуют отдельных PSP;
- часто имеют асинхронный flow.

Routing должен учитывать их особенности
(особенно для payout).

---

## 6. Cost vs Approval vs Risk

Routing — это всегда компромисс между:
- Approval Rate;
- Cost (fees, chargebacks);
- Risk (fraud, compliance).

Пример:
- PSP с высоким approval может быть дорогим;
- дешёвый PSP может давать больше chargebacks.

Роль Ops:
> находить оптимальный баланс, а не максимизировать одну метрику.

---

## 7. Метрики для оценки PSP

Ключевые показатели:
- Approval Rate;
- Decline Distribution;
- Failure Rate;
- Latency p95/p99;
- Chargeback Rate;
- Payout SLA;
- Incident frequency.

Сравнение PSP должно быть:
- регулярным;
- сегментированным;
- основанным на данных.

---

## 8. Типичные ошибки в routing

- routing «один раз и навсегда»;
- оптимизация только по approval;
- отсутствие fallback;
- слишком агрессивные retries;
- игнорирование GEO-специфики.

---

## 9. Роль PSP Ops в routing-стратегии

PSP Ops:
- анализирует метрики;
- предлагает изменения routing;
- тестирует гипотезы;
- контролирует impact;
- взаимодействует с PSP и продуктом.

Routing — это живой процесс, а не настройка.

---

## 10. Key takeaways

- Routing — ключевой рычаг Ops.
- Один PSP — высокий риск.
- Fallback и retries требуют дисциплины.
- GEO и методы имеют значение.
- Хороший routing повышает стабильность и выручку.

---

## 11. Как использовать эту главу

1. Прочитать и понять модели routing.
2. Привязать routing к метрикам.
3. Использовать данные для принятия решений.
4. На интервью объяснять routing через trade-offs.

Эта глава завершает базовую операционную модель PSP Ops.
