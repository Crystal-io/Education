# 01. Payment Lifecycle: Deposit & Payout

## Цель главы

Эта глава объясняет, **как на самом деле работают платежи в iGaming/FinTech системах** и какую роль в этом играет PSP Account Manager (Operations).

После прочтения ты должен:
- понимать полный lifecycle депозита и вывода средств;
- видеть ключевые точки отказов и задержек;
- понимать, как технические статусы и события превращаются в бизнес-метрики;
- уметь логически связать проблему в продакшене с конкретным шагом платежного флоу.

---

## 1. Общая идея платежного lifecycle

Любой платеж — это **не один запрос**, а цепочка шагов между несколькими участниками:

- клиент (player);
- платёжная система продукта (cashier / gateway);
- платёжный провайдер (PSP);
- acquiring банк;
- issuing банк клиента;
- вспомогательные сервисы (3DS, antifraud, KYC, AML, ledger).

Для Operations важно понимать:
> платеж может «сломаться» **на любом шаге**, и внешне это будет выглядеть одинаково — как failed / pending / timeout.

Задача PSP Ops — **найти точку, где именно произошёл сбой**, и определить, что с этим делать.

---

## 2. Deposit Lifecycle (L2)

### 2.1. Типовой flow депозита

Упрощённо депозит выглядит так:

1. Клиент выбирает метод оплаты в cashier.
2. Система создаёт payment intent / order.
3. Routing выбирает PSP (или последовательность PSP).
4. Клиент проходит redirect / SDK / APM-флоу.
5. PSP отправляет запрос в acquiring банк.
6. Acquirer взаимодействует с issuing банком клиента.
7. При необходимости запускается 3DS / SCA.
8. Клиент возвращается в продукт.
9. PSP отправляет webhook / callback с финальным статусом.
10. Система обновляет ledger и баланс клиента.

Важно:  
**финальный статус почти всегда асинхронный**, даже если пользователь видит «успешно».

---

### 2.2. Ключевые точки отказов в депозитах

#### До PSP (merchant / gateway layer)
Типичные проблемы:
- неверная подпись запроса;
- некорректная сумма или валюта;
- дубликаты без idempotency;
- ошибки конфигурации merchant account.

Как проявляется:
- быстрые `failed`;
- высокий процент технических ошибок;
- одинаковые ошибки на всех PSP.

---

#### PSP layer
Типичные проблемы:
- outage провайдера;
- превышение лимитов;
- internal PSP rules;
- нестабильные webhooks.

Как проявляется:
- рост timeouts;
- увеличение pending;
- падение approval сразу по всем банкам.

---

#### Acquirer / Issuer
Типичные проблемы:
- issuer declines (`do not honor`, `insufficient funds`);
- geo или card restrictions;
- bank-level antifraud.

Как проявляется:
- падение approval rate;
- рост определённых decline codes;
- проблема часто ограничена GEO или банками.

---

#### 3DS / SCA
Типичные проблемы:
- friction для пользователя;
- таймауты challenge;
- несовместимость браузера/устройства.

Как проявляется:
- падение conversion;
- рост abandoned payments;
- approval может быть нормальным, но итоговая конверсия падает.

---

### 2.3. Что важно для Operations при депозитах

PSP Ops **не чинит код**, но он должен:
- понимать, **на каком шаге** происходит сбой;
- уметь сегментировать проблему (PSP / GEO / метод / банк);
- быстро предложить mitigation:
  - fallback PSP;
  - изменение routing;
  - временное отключение метода;
  - эскалацию провайдеру с конкретными примерами.

---

## 3. Payout Lifecycle (L2)

### 3.1. Отличие payout от deposit

Вывод средств:
- медленнее;
- строже контролируется;
- сильнее связан с рисками (fraud, AML, chargebacks).

Для бизнеса payout — это:
> доверие клиента и репутация продукта.

---

### 3.2. Типовой flow payout

1. Клиент инициирует вывод средств.
2. Выполняются pre-checks:
   - KYC статус;
   - AML / risk rules;
   - лимиты;
   - баланс.
3. Создаётся payout request.
4. Routing выбирает payout-провайдера.
5. Запрос уходит в PSP.
6. PSP обрабатывает payout асинхронно.
7. Приходят промежуточные статусы (`pending`, `processing`).
8. Финальный статус (`completed`, `failed`, `reversed`).
9. Обновляется ledger и уведомляется клиент.

---

### 3.3. Где чаще всего «застревают» выплаты

#### Compliance / Risk layer
- ручные проверки;
- дополнительные документы;
- подозрительная активность.

Проявление:
- выплаты «висят» часами или днями;
- формально ошибок нет, но SLA нарушен.

---

#### Provider layer
- низкая пропускная способность;
- batch-обработка;
- локальные банковские праздники.

Проявление:
- рост payout time-to-complete;
- жалобы клиентов;
- давление на support.

---

#### Integration layer
- статусы не совпадают;
- webhook не дошёл;
- payout completed у PSP, но pending у нас.

Проявление:
- reconciliation issues;
- ручные корректировки;
- операционный хаос.

---

### 3.4. Что важно для Operations при payout

PSP Ops должен:
- контролировать SLA по выплатам;
- понимать, где задержка «нормальная», а где инцидент;
- уметь объяснить бизнесу причину задержек;
- держать коммуникацию с провайдером под контролем.

---

## 4. Связь lifecycle и метрик

Каждый шаг lifecycle напрямую влияет на метрики:

- проблемы до PSP → технический failure rate;
- issuer declines → approval rate;
- 3DS проблемы → conversion;
- payout delays → support tickets и churn.

Важно понимать:
> метрика — это **следствие**, а не причина.

Работа PSP Account Manager (Operations) начинается **с метрики**, но заканчивается **на конкретном шаге lifecycle**.

---

## 5. Key takeaways

- Платёж — это цепочка, а не один запрос.
- Большинство проблем не уникальны, а повторяются по шаблонам.
- Operations думает шагами и причинами, а не статусами.
- Умение связать lifecycle → метрику → действие — ключевая компетенция PSP Ops.

---

## 6. Как использовать эту главу дальше

1. Прочитать целиком без спешки.
2. Закрыть файл.
3. Попробовать вслух объяснить:
   - депозит;
   - payout;
   - где и почему они ломаются.
4. Перейти в `Quick/flows/*` и использовать как тренажёр.

Эта глава — фундамент для всех следующих.
